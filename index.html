# mongodb  

### mongodb的基本操作  
    1. 查看当前的数据库：db
    2. 查看所有的数据库：show dbs / show databases
    3. 切换数据库 use db_name
    4. 删除当前的数据库 db.dropDatabase()

### mongodb 集合的基础命令
    1. 非手动创建集合，想不存在的集合中第一次加入数据时，集合会被自动创建出来。
    2. 手动创建集合：
        > db.createCollection(name, options)
        > db.createCollection("stu")
        > db.createCollection("sub", {capped: true, size: 10})
        > 参数capped：默认值为false，表示不设置上线，值为true时表示设置上限。
        > 参数size：当capped值为true时，需要指定此参数，表示上限大小，当文档达到上限时，会将之前的数据覆盖，单位为字节。
    3. 参看集合：show collections
    4. 删除集合：db.集合名称.drop()

### 数据类型
    Object ID: 文档id  
    String: 字符串，最常用，必须是有效的UTF-8  
    Boolean: 存储一个布尔值，true或false  
    Integer: 整数可以是32位或64位，这取决于服务器。  
    Bouble: 存储浮点值  
    Arrays: 数组或列表，多个值存储到一个键  
    Object: 用于嵌入式的文档，即一个值为一个文档  
    Null: 存储Null值  
    Timestamp: 时间戳，表示从1970-1-1到现在的总秒数  
    Date: 存储当前日期或时间的UNIX时间格式  
        > 创建日期语句如下: 参数的格式为YYYY-MM-DD  
        > new Date('2017-12-20')  
        > 每个文档都有一个属性，为_id，保证每个文档的唯一性  
        > 可以自己去设置_id插入文档，如果没有提供，那么MongoDB为每个文档提供一个独特的_id，类型为objectID  
        > ObjectID是一个12字节的十六进制数  
            a. 4个字节为当前时间戳  
            b. 3个字节的机器ID  
            c. 2个字节为MongoDB的服务进程id  

### object操作
    1. 插入
        > 插入 db.[集合名称].insert(document)
        > db.stu.insert({[json]})
        > db.stu.insert({_id:"obj_id", [json]})
        > 插入文档时，如果不指定_id参数，MongoDB会为文档分配一个唯一的Objectd
    2. 保存
        > db.[集合名词].save(document)
        > 如果文档的_id已经存在则修改，如果文档的_id不存在则添加
    3. 更新
        > db.[集合名词].update(<query>, <update>, {multi:<boolean>})
        > 参数query: 查询条件
        > 参数update：更新操作符
        > 参数muluti: 可选，默认是false，表示只更新找到的第一条记录，值为True表示把满足条件的文档全部更新
        > 注意： multi update only works with $ operators
    4. 删除
        > db.[集合名称].remove(<query>, {justOne:<boolean>})
        > 参数query：可选，删除的文档条件
        > 参数justOne: 可选，如果设置为true或1，则只删除一条，默认为false，表示删除多条。
        > 注意：默认情况下，会将符合条件的文档全部删除，这与修改的默认策略截然不同
    5. 查询
        > 方法find(): 查询  db.[集合名词].find({条件json})
        > 方法findOne(): 查询,只返回第一个  db.集合名词.findOne({条件json})
        > 方法pretty(): 将结果格式化    db.[集合名词].find({条件文档}).pretty()
    6. 比较运算符
        =     默认是等于判断，没有运算符
        <     $lt (less than)
        >=    $lte (less than equal)
        >     $gt (greater than)
        >=    $gte
        !=    $ne
    7. 范围运算符
        (*)=  $in (多等于)
        (*)!= $nin (多不等于)
    8. 逻辑运算符
        > and:  在json中写多个条件即可.
        > or:   使用$or,值为数组,数组中每个元素都为{json}
    9. 正则表达式
        > 使用 // 或 $regex 编写正则表达式
    10. limit skip
        > limit(): 用于读取指定数量的文档
        > skip(): 用于跳过指定数量的文档
        > 注意：二者可同时使用
    11. 自定义查询
        > 使用 $where 后面写一个函数,返回满足条件的数据。
    12. 投影
        > 在查询到的返回结果中，只选择必要的字段
        > db.[集合名称].find({字段名称:1,...})
        > 参数字段与值，值为表示显示,值为0不显示.
        > 对于_id列默认是显示的，如果不显示需要明确设置为0
    13.排序
        > 方法sort(),用于对集进行排序
        > db.集合名称.find().sort({字段:1,...})
        > 参数1为升序排列,参数-1为降序排列
    14.统计个数
        > 方法count() 用于统计结果集中的文档条数
    15.去重
        > 方法 distinct("去重键", {json条件}) 对数据进行去重

### 数据的备份与恢复
    1. 备份语法
        > mongodump -h dbhost -d dbname -o dbdirectory
        > -h 服务器地址,也可以指定端口号
        > -d 需要备份的数据库名称
        > -o 备份的数据存放位置,此目录中存放着备份出来的数据。
    2. 恢复语法
        > mongorestore -h dbhost -d dbname --dirdb directory
        > -h 服务器地址
        > -d 需要恢复的数据库实例
        > --dir 备份数据所在位置

### 聚合aggregate
    聚合(aggregate)是基于数据处理的聚合管道，每个文档通过一个由多个阶段(stage)组成的管道,可以对每个阶段的管道进行分组，过滤等功能，然后经过一系列的处理，输出相应的结果。
    db.[集合名称.aggregate]({管道:{表达式}})
    1. 表达式
        > 处理输入文档并输出
        > 语法：表达式:'$列名'
        > $sum:     计算总和， $sum:1 表示以一倍计数
        > $avg:     计算平均值
        > $min:     获取最小值
        > $max:     获取最大值
        > $push:    在结果文档中插入值到一个数组中
        > $first:   根据资源文档的排序获取第一个文档数据
        > $last:    根据资源文档的排序获取最后一个文档数据
    2. $group 将集合中的文档分组,可用于统计结果
        > _id表示分组的依据,使用每个字段的格式为'$字段'
        > $group 对应的字典中有几个键，结果中就有几个键
        > 取不同的字段的值需要使用$, $gender, $age
        > 取字典嵌套的字典中的值的时候 $_id.country
        > 能够同时按照多个键进行分组{$group:{_id:{country:"$country", province:"$province"}}}
    3. $project
        > 修改输入文档的结构，如重命名，增加，删除字段，创建计算结果
    4. $match
        > 用于过滤数据,只输出符合条件的文档
    5. $sort
        > 将输入文档排序后输出
    6. $limit
        > 限制聚合管道返回的文档数
    7. $skip
        > 跳过指定数量的文档，并返回余下的文档
        > 注意，先使用skip,后使用limit,以提高性能
    8. $unwind
        > 将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值
        > unwind在字段等于 null, []的时候,属性 preserveNullAndEmptyArrays值为true，表示保留属性值为空的文档
        > db.t.aggregate({$unwind:{path:'$字段名', preserveNullAndEmptyArrays:<boolean>}})

### 创建索引
    索引: 以提升查询速度
    语法: db.集合.ensureIndex({属性:1}), 1表示升序, -1表示降序
        > 在大部分情况下,索引的升降序过度的影响查询速度
        > 但在 sort 情况下, 同序性能会更优
        > .explain('executionStats') 可获得查询时间等相关信息
        > db.t.getindexes() 查看当前集合的所有索引
        > db.t.dropIndex('索引名')
        > 索引unique db.t.ensureIndex({"name":1}, {"unique": true})
        > 联合索引 db.t.ensureIndex({name:1, age:1})

### pymongo
    from pymongo import MongoClint
```python
# conding=utf-8

from pymongo import MongoClient

class TestMongo:
    def __init__(self):
        client = MongoClient(host="127.0.0.1", port=27017)
        collection = client["test"]["test1"]

        # 插入多条数据, 返回插入的_id
        # ret1 = collection.insert({"name":"xiaohong", "age": 10}) 
        # print(ret1)

        # 插入多条数据
        # data_list = [{"name": "test{}".format(i)} for i in range(15,20)]
        # rets = collection.insert_many(data_list)
        # print(rets)

        # 查询一个记录 :{'_id': ObjectId('5e81eba91968627157ad0349'), 'name': 'test15'}
        # t = collection.find_one({"name": "test15"})
        # print(t)
        
        # 查询所有记录
        # cu = collection.find({"name": "test15"})
        # print(cu)
        # for i in cu:
        #     print(i)
        # cu_lst = list(cu)
        #  <pymongo.cursor.Cu rsor object at 0x0000023E264D9490>
        # {'_id': ObjectId('5e81eba91968627157ad0349'), 'name': 'test15'}
        # Cursor 游标

        # 更新一条记录
        # ret = collection.update_one({"name": "test16"}, {"$set": {"name": "new_test16"}})
        # print(ret)
        # <pymongo.results.UpdateResult object at 0x0000024593F60900>
        # 更新全部
        # collection.update_many({})

        # 删除
        # collection.delete_one()
        # collection.delete_many()

class main():
    TestMongo()

if __name__ == "__main__":
    main()
```


```ipython
In [1]: import datetime

In [2]: datetime.datetime.now()
Out[2]: datetime.datetime(2020, 3, 27, 11, 16, 51, 308012)

In [3]: type(datetime.datetime.now())
Out[3]: datetime.datetime
```

```mongodb
> show collections
> new Date("2019-12-12")
# ISODate对应datetime.datetime类型
ISODate("2019-12-12T00:00:00Z")
> db.test1.insert({"name": "xiaowang", "age":10})
WriteResult({ "nInserted" : 1 })
> db.test1.find()
{ "_id" : ObjectId("5e7d71a5b36e3c138608d6c3"), "name" : "xiaowang", "age" : 10 }
> db.test1.insert({name:"xiaohong", age:18})
WriteResult({ "nInserted" : 1 })
> db.test1.find()
{ "_id" : ObjectId("5e7d71a5b36e3c138608d6c3"), "name" : "xiaowang", "age" : 10 }
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaohong", "age" : 18 }
> db.test1.save({ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaohong", "age" : 16 })
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.test1.find()
{ "_id" : ObjectId("5e7d71a5b36e3c138608d6c3"), "name" : "xiaowang", "age" : 10 }
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaohong", "age" : 16 }

# 修改update
> db.test1.update({"name" : "xiaowang"}, {"name" : "xiaoming"})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.test1.find()
{ "_id" : ObjectId("5e7d71a5b36e3c138608d6c3"), "name" : "xiaoming" }
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaohong", "age" : 16 }
# 使用 $set:{json} 进行选定字符串修改
> db.test1.update({"name" : "xiaohong"}, {$set:{"name": "xiaoqiang"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
{ "_id" : ObjectId("5e7d71a5b36e3c138608d6c3"), "name" : "xiaoming" }
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaoqiang", "age" : 16 }

# 删除
> db.test1.remove({name:"xiaoming"},{justOne:true})
WriteResult({ "nRemoved" : 1 })
> db.test1.find()
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaoqiang", "age" : 16 }

# 查询
> db.test1.find({age:{$lte:18}})
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaoqiang", "age" : 16 }
> db.test1.find({age:{$in:[16, 18]}})
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaoqiang", "age" : 16 }
# 使用 $where:function
> db.test1.find({$where:function(){return this.age<=18}})
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaoqiang", "age" : 16 }
# 只返回特定数据
> db.test1.find({$where:function(){return this.age<=18}},{name:1})
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaoqiang"}

# 备份
PS C:\Users\Night\code\mongodb> mongodump -d test1 -o .
2020-03-27T23:31:54.301+0800    writing test1.test1 to
2020-03-27T23:31:54.384+0800    done dumping test1.test1 (1 document)
PS C:\Users\Night\code\mongodb> ls
    目录: C:\Users\Night\code\mongodb
Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         2020/3/27     23:31                test1

# 恢复
PS C:\Users\Night\code\mongodb> mongorestore -d test2 --dir test1
2020-03-27T23:39:34.469+0800    the --db and --collection args should only be used when restoring from a BSON file. Other uses are deprecated and will not exist in the future; use --nsInclude instead
2020-03-27T23:39:34.501+0800    building a list of collections to restore from test1 dir
2020-03-27T23:39:34.504+0800    reading metadata for test2.test1 from test1\test1.metadata.json
2020-03-27T23:39:34.539+0800    restoring test2.test1 from test1\test1.bson
2020-03-27T23:39:34.544+0800    no indexes to restore
2020-03-27T23:39:34.544+0800    finished restoring test2.test1 (1 document, 0 failures)
2020-03-27T23:39:34.544+0800    1 document(s) restored successfully. 0 document(s) failed to restore.

# 聚合 aggregate
> db.test1.aggregate(
    {$group:{_id:"$age", count:{$sum:1}}}
    )
{ "_id" : 16 }
>  db.test1.aggregate(
...     {$group:{_id:"$age", count:{$sum:1}}}
...     )
{ "_id" : 16, "count" : 1 }
> db.test1.aggregate(
...     {$group:{_id:"$age",
...     count:{$sum:1},
...     avg_age:{$avg:"$age"}
...     }}
...     )
{ "_id" : 16, "count" : 1, "avg_age" : 16 }
> db.test1.aggregate(
...     {
...         $group:{
...             _id:"$age",
...             count:{$sum:1},
...             avg_age:{$avg:"$age"}
...         }
...     },
...     {
...         $project:{
...             gender:"$_id",
...             count:"$count",
...             avg_age:"$avg_age"
...         }
...     }
... )

{ "_id" : 16, "gender" : 16, "count" : 1, "avg_age" : 16 }
> db.test1.insert({"username": "Alex", "tags":['C#', 'Java', 'C++']})
WriteResult({ "nInserted" : 1 })
> db.test1.find()
{ "_id" : ObjectId("5e7d72cfb36e3c138608d6c4"), "name" : "xiaoqiang", "age" : 16 }
{ "_id" : ObjectId("5e8001f313c2dc467a07b8d8"), "username" : "Alex", "tags" : [ "C#", "Java", "C++" ] }
> db.test1.aggregate({$match:{username:"Alex"}})
{ "_id" : ObjectId("5e8001f313c2dc467a07b8d8"), "username" : "Alex", "tags" : [ "C#", "Java", "C++" ] }
> db.test1.aggregate({$match:{username:"Alex"}},{$unwind:"$tags"})
{ "_id" : ObjectId("5e8001f313c2dc467a07b8d8"), "username" : "Alex", "tags" : "C#" }
{ "_id" : ObjectId("5e8001f313c2dc467a07b8d8"), "username" : "Alex", "tags" : "Java" }
{ "_id" : ObjectId("5e8001f313c2dc467a07b8d8"), "username" : "Alex", "tags" : "C++" }
> db.test1.aggregate({$match:{username:"Alex"}},{$unwind:"$tags"},{$group:{_id:null, sum:{$sum:1}}})
{ "_id" : null, "sum" : 3 }

# 索引
> use test2
switched to db test2
> for(i=0; i<100000; i++){db.test2.insert({name:'test'+i, age:i})}
WriteResult({ "nInserted" : 1 })
> db.test2.find().count()
100000
> db.test2.find()
{ "_id" : ObjectId("5e80087a13c2dc467a07b8d9"), "name" : "test0", "age" : 0 }
Type "it" for more
> db.test2.find({name:"test99999"})
{ "_id" : ObjectId("5e8008b813c2dc467a093f78"), "name" : "test99999", "age" : 99999 }
> db.test2.find({name:"test99999"}).explain('executionStats')
{
    ...
}
# 创建索引
> db.test2.ensureIndex({name:1})
{
        "createdCollectionAutomatically" : false,
        "numIndexesBefore" : 1,
        "numIndexesAfter" : 2,
        "ok" : 1
}
# 查看当前库的所有索引
> db.test2.getIndexes()
[
        {
                "v" : 2,
                "key" : {
                        "_id" : 1
                },
                "name" : "_id_",
                "ns" : "test2.test2"
        },
        {
                "v" : 2,
                "key" : {
                        "name" : 1
                },
                "name" : "name_1",
                "ns" : "test2.test2"
        }
]

# 删除索引
> db.test2.dropIndex({name:1})
{ "nIndexesWas" : 2, "ok" : 1 }
> db.test2.getIndexes()
[
        {
                "v" : 2,
                "key" : {
                        "_id" : 1
                },
                "name" : "_id_",
                "ns" : "test2.test2"
        }
]

db.test1.aggregate(
    {
        $match:{
            $or:[
                {age:{$gt:15}},
                {name:{
                        $in:["xiaoming","xiaoqiang","xiaohong"]
                    }
                }
            ]
        }
    },
    {
        $group:{
            _id:"$age",
            count:{$sum:1},
            avg_age:{$avg:"$age"}
        }
    },
    {
        $project:{
            gender:"$_id",
            count:"$count",
            avg_age:"$avg_age"
        }
    }
)
```